---
title: "Single Site Short Run SDA Analysis"
author: "Marissa Kivi"
date: "3/23/2020"
output: html_document
---

The following script completes a short general analysis of a single SDA run. It considers the species parameters which are most important to total stand productivity, as well as to PFT-level productivity. Then, it creates a few plots, which allow us to consider model bias over time so we can identify time periods where LINKAGES consistently struggles both at the stand- and PFT-level. 
  
```{R, echo = FALSE, include = FALSE}
rm(list=ls())
library(mvtnorm)
library(PEcAn.workflow)
library(PEcAn.settings)
library(ggplot2)
library(gridExtra)
library(boot)
library(reshape2)
library(dplyr)
library(class)
library(GGally)
library(randomForest)

# if you want to rerun data-collecting script no matter what 
overwrite = FALSE

# edit these variables according to your run/preferences
id = 14000000089
disturbance.yrs = c(1938,1970)
site = 'HF' # I just use initials here; no spaces for column names 
obs.list.loc = paste0('/data/dbfiles/sda.obs.HARVARD.RData')

min.cor = 0.3

```

# Gather site data 
```{R, echo = FALSE, include = FALSE}

if (!file.exists(paste0('/data/workflows/PEcAn_',toString(id),'/analysis.Rdata')) | overwrite){
  source('~/VM_scripts/gather.sda.data.R') 
  load(obs.list.loc)
  data = gather_sda_data(id=id, obs.list=obs.list, disturbance.yrs=disturbance.yrs, init=site)
  save(data, obs.list, file = paste0('/data/workflows/PEcAn_',toString(id),'/analysis.Rdata'))
  rm(dump.log, obs.list.loc, gather_sda_data)
}else{
  load(paste0('/data/workflows/PEcAn_',toString(id),'/analysis.Rdata'))
}

```

# Further organize data for easy analysis
```{R, echo = FALSE, include = FALSE}

# Preliminary organization
# Organize average wts of ensembles 
avg.wts = data$weight.melt %>% group_by(ensemble) %>% summarize(wt = mean(weight))
pars = unique(data$param.melt$p.name)
spp = data$spp

# Step 1 and 2: Parameter vs. pft-level and stand growth 
param.cast = left_join(data$param.melt, avg.wts, by = 'ensemble') %>%
  left_join(data$growth.melt %>% group_by(ensemble) %>% summarize(total = mean(total)), by = 'ensemble') %>%
  left_join(dcast(data$life.melt %>% 
                    dplyr::select(-site, -birth, -death) %>% 
                    group_by(ensemble, species) %>% 
                    summarize(growth = mean(growth)),
                    ensemble ~ species, value.var = 'growth'), 
            by = 'ensemble')

# Step 1 and 2: Average life processes at PFT level
life.avg = data$life.melt %>% 
  dplyr::select(-site) %>%
  group_by(ensemble, species) %>%
  summarize(birth = mean(birth), growth = mean(growth), death = mean(death))
  
# Step 3: Total and PFT-level biases over time
bias.melt = data$bias.melt
```

# Step 1: Species parameters vs. total predicted stand growth 

```{R, echo = FALSE}

# iterate through all species and all parameters and compute weighted correlation
for (s in seq_along(spp)){
  for (p in seq_along(pars)){
    
    # compute weighted correlation
    data.now = param.cast %>% filter(species == spp[s], p.name == pars[p]) %>% dplyr::select(p.value, total, wt, ensemble)
    
    # HACK
    if (sd(data.now$p.value)==0) next
    
    wt.cor = corr(cbind(data.now$p.value,data.now$total), w = data.now$wt)
    
    # if weighted correlation meets minimum value, plot, print, and check life processes
    if (abs(wt.cor) > min.cor){
      
      # print plot
      pl = ggplot(data.now, aes(x=p.value, y=total)) + 
        geom_point(aes(col=wt)) + 
        geom_smooth(method='lm') +
        labs(x=paste(spp[s],pars[p]), y='predicted stand growth', col='weight')
      print(pl)
      
      # print
      print(paste(spp[s], pars[p], "::", wt.cor))
      
      # check against average life processes for speciess 
      for (s2 in seq_along(spp)){
        
        life.data = life.avg %>% filter(species == spp[s2]) %>% left_join(data.now, by = 'ensemble')
        wt.birth = corr(cbind(life.data$p.value, life.data$birth), w=life.data$wt)
        wt.growth = corr(cbind(life.data$p.value, life.data$growth), w=life.data$wt)
        wt.death = corr(cbind(life.data$p.value, life.data$death), w=life.data$wt)
        
        if (!is.na(wt.birth)){
          if (abs(wt.birth) > min.cor) print(paste('>>',spp[s2],'birth ::', wt.birth))
        }
        if (!is.na(wt.growth)){
          if (abs(wt.growth) > min.cor) print(paste('>>',spp[s2],'growth ::', wt.growth))
        }
        if (!is.na(wt.death)){
          if (abs(wt.death) > min.cor) print(paste('>>',spp[s2],'death ::', wt.death))
        }
      }
    }
  }
}
```

# Step 2: Species parameters vs. predicted pft-level growth 

```{R, echo = FALSE}

# iterate through all species and species parameters and compute weighted correlation
for (s1 in seq_along(spp)){
  for (s2 in seq_along(spp)){
    for (p in seq_along(pars)){
      
      # compute weighted correlation
      data.now = param.cast %>% filter(species == spp[s2], p.name == pars[p]) %>% dplyr::select(p.value, wt, ensemble, one_of(c(spp[s1])))
    
      # HACK
      if (sd(data.now$p.value)==0 | any(is.na(data.now[[spp[s1]]]))) next

      wt.cor = corr(cbind(data.now$p.value, data.now[[spp[s1]]]), w = data.now$wt)
    
      # if weighted correlation meets minimum value, plot, print, and check against life processes
      if (abs(wt.cor) > min.cor){
      
        # print plot
        pl = ggplot(data.now, aes_string(x='p.value', y=spp[s1])) + 
          geom_point(aes(col=wt)) + 
          geom_smooth(method='lm') +
          labs(x=paste(spp[s2],pars[p]), y=paste('Predicted Growth of',spp[s1]), col='weight')
        print(pl)
      
        # print
        print(paste(spp[s1],'growth vs',spp[s2], pars[p], "::", wt.cor))
        
        # check against average life processes for speciess 
        for (s3 in seq_along(spp)){
          life.data = life.avg %>% filter(species == spp[s3]) %>% left_join(data.now, by = 'ensemble')
          wt.birth = corr(cbind(life.data$p.value, life.data$birth), w=life.data$wt)
          wt.growth = corr(cbind(life.data$p.value, life.data$growth), w=life.data$wt)
          wt.death = corr(cbind(life.data$p.value, life.data$death), w=life.data$wt)
          
          if (!is.na(wt.birth)){
            if (abs(wt.birth) > min.cor) print(paste('>>',spp[s3],'birth ::', wt.birth))
          }
          if (!is.na(wt.growth) & (s1 != s3)){
            if (abs(wt.growth) > min.cor) print(paste('>>',spp[s3],'growth ::', wt.growth))
          }
          if (!is.na(wt.death)){
            if (abs(wt.death) > min.cor) print(paste('>>',spp[s3],'death ::', wt.death))
          }
        }
      }
    }
  }
}
  
```

# Step 3: Model bias over time

## A. Total model bias over time

```{R, echo = FALSE}

bias.melt %>% 
  ggplot(aes(x = year + 1960, y = total, col = ensemble, group = ensemble)) +
  ylim(-1,1) +
  geom_line(show.legend = FALSE) + 
  labs(title = 'model error over time', x = 'year', y = 'relative model bias')

for (s in seq_along(spp)){
  print(bias.melt %>% 
          ggplot(aes(x = year + 1960, col = ensemble, group = ensemble)) + 
          ylim(-1,1) + 
          geom_line(aes_string(y = spp[s]), show.legend = FALSE) + 
          labs(title = paste(spp[s],':: model error over time'), x = 'year', y = 'relative model bias')
  )
}

```
